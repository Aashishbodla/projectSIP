<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Particles.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <style>
    /* Animated Gradient Background */
    body {
      background: linear-gradient(135deg, #6B46C1, #4C51BF, #7F9CF5, #6B46C1);
      background-size: 400%;
      animation: gradientShift 15s ease infinite;
      overflow-x: hidden;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Particles Container */
    #particles-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    /* 3D Floating Spheres */
    .sphere {
      position: absolute;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.3), rgba(107, 70, 193, 0.1));
      border-radius: 50%;
      animation: floatSphere 20s infinite ease-in-out;
      box-shadow: 0 0 20px rgba(107, 70, 193, 0.5);
      transform-style: preserve-3d;
      z-index: 1;
    }
    @keyframes floatSphere {
      0%, 100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
      50% { transform: translateY(-50vh) rotateX(360deg) rotateY(360deg); }
    }
    /* Hero Parallax */
    header {
      position: relative;
      background-attachment: fixed;
      background-size: cover;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(107, 70, 193, 0.8), rgba(76, 81, 191, 0.8));
      z-index: 0;
      transform: translateZ(-1px) scale(2);
    }
    header > * {
      position: relative;
      z-index: 1;
    }
    /* Typewriter Effect for Hero Headline */
    #hero-headline {
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      border-right: 3px solid white;
      animation: typing 3s steps(30, end), blink 0.75s step-end infinite;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink {
      50% { border-color: transparent; }
    }
    /* Fade-in for Hero Elements */
    .fade-in {
      opacity: 0;
      animation: fadeIn 1s ease-in forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    /* Navigation Glow Effect */
    nav a, nav button {
      position: relative;
      transition: all 0.3s ease;
    }
    nav a::after, nav button::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -2px;
      left: 0;
      background: #A78BFA;
      transition: width 0.3s ease;
    }
    nav a:hover::after, nav button:hover::after {
      width: 100%;
    }
    nav a:hover, nav button:hover {
      color: #A78BFA !important;
    }
    #notificationBell:hover i {
      transform: scale(1.2);
      text-shadow: 0 0 10px rgba(107, 70, 193, 0.8);
    }
    /* 3D Flip Card for How It Works */
    .card {
      perspective: 1000px;
      height: 200px;
      transition: transform 0.3s ease;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .card:hover .card-inner {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card-back {
      transform: rotateY(180deg);
      background: linear-gradient(135deg, #A78BFA, #7F9CF5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    /* Doubt Card Hover */
    .doubt-card {
      transition: all 0.3s ease;
    }
    .doubt-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    /* Hero Button Hover */
    .hero-button {
      transition: all 0.3s ease;
    }
    .hero-button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      background: #A78BFA !important;
      color: white !important;
    }
  </style>
</head>
<body class="min-h-screen relative">
  <!-- Interactive Particles -->
  <div id="particles-js"></div>
  <!-- 3D Floating Spheres -->
  <div class="sphere w-12 h-12 top-10 left-10"></div>
  <div class="sphere w-16 h-16 top-20 right-20"></div>
  <div class="sphere w-10 h-10 bottom-30 left-30"></div>

  <!-- Navigation -->
  <nav class="bg-white shadow-sm z-20 relative">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="index.html" class="flex items-center space-x-2">
        <i class="fas fa-graduation-cap text-purple-600 text-2xl"></i>
        <span class="text-xl font-bold text-gray-800">StudyConnect</span>
      </a>
      <div class="flex items-center space-x-4" id="authNav">
        <div id="notificationBell" class="relative cursor-pointer">
          <i class="fas fa-bell text-purple-600 text-xl transition-all"></i>
          <span id="unreadCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </div>
        <span id="userGreeting" class="text-gray-600">Hello, Guest</span>
        <a href="post-doubt.html" class="text-purple-600 hover:text-purple-800">Post Doubt</a>
        <a href="my-doubts.html" class="text-purple-600 hover:text-purple-800">My Doubts</a>
        <a href="#" class="text-purple-600 hover:text-purple-800">Logout</a>
      </div>
    </div>
  </nav>
  <div id="notificationDropdown" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg hidden p-4 z-20">
    <h3 class="text-lg font-semibold text-gray-700 mb-2">Notifications</h3>
    <div id="notificationList" class="space-y-2 max-h-40 overflow-y-auto"></div>
    <button id="markAllRead" class="mt-2 w-full text-sm text-purple-600 hover:text-purple-800">Mark All as Read</button>
  </div>

  <!-- Hero Section with Parallax -->
  <header class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-20 text-center relative z-10">
    <div class="max-w-4xl mx-auto px-4">
      <h1 id="hero-headline" class="text-4xl md:text-5xl font-bold mb-4">Peer-to-Peer Academic Assistance</h1>
      <p class="text-lg mb-6 fade-in" style="animation-delay: 0.3s;">Connect with fellow students to get help with your academic doubts or share your knowledge.</p>
      <div class="space-x-4 fade-in" style="animation-delay: 0.6s;">
        <a href="post-doubt.html" class="bg-white text-purple-600 px-6 py-3 rounded-full font-semibold hero-button">ðŸ¤” Ask a Question</a>
        <a href="solve-doubt.html" class="bg-purple-700 text-white px-6 py-3 rounded-full font-semibold hero-button">ðŸ™Œ Help Others</a>
      </div>
    </div>
  </header>

  <!-- How It Works Section with 3D Flip Cards -->
  <section class="max-w-6xl mx-auto px-4 py-12 relative z-10">
    <h2 class="text-3xl font-bold text-center mb-10 text-white">How It Works</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div class="card">
        <div class="card-inner">
          <div class="card-front">
            <div class="mx-auto mb-4 w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-pen text-purple-600"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">Post Your Doubt</h3>
            <p class="text-gray-600">Stuck on a problem? Post your academic question.</p>
          </div>
          <div class="card-back">
            <p class="text-sm">Share details like subject, branch, and location to get targeted help from peers.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-inner">
          <div class="card-front">
            <div class="mx-auto mb-4 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-comments text-blue-600"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">Get Responses</h3>
            <p class="text-gray-600">Other students can respond with solutions.</p>
          </div>
          <div class="card-back">
            <p class="text-sm">Receive answers and contact info to connect directly with helpers.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-inner">
          <div class="card-front">
            <div class="mx-auto mb-4 w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fas fa-users text-green-600"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">Connect & Learn</h3>
            <p class="text-gray-600">Meet offline or discuss to solve together.</p>
          </div>
          <div class="card-back">
            <p class="text-sm">Collaborate with peers to deepen your understanding and build connections.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- My Doubts Section with Summary -->
  <section class="max-w-6xl mx-auto px-4 py-12 relative z-10" id="myDoubtsSection" style="display: none;">
    <h2 class="text-3xl font-bold text-center mb-6 text-white">My Doubts</h2>
    <p class="text-center text-gray-200 mb-6">Check the responses to your posted doubts.</p>
    <div id="myDoubtsList" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3"></div>
    <div id="noDoubts" class="text-center py-12 hidden">
      <h3 class="text-xl font-medium text-gray-200">No doubts found</h3>
      <p class="text-gray-400">Post a doubt to get started!</p>
    </div>
  </section>

  <script type="module">
    import { auth } from './js/auth.js';
    import { api } from './js/api.js';
    import { utils } from './js/main.js';

    window.auth = auth;
    window.api = api;
    window.utils = utils;

    // Initialize Particles.js
    particlesJS('particles-js', {
      particles: {
        number: { value: 50, density: { enable: true, value_area: 800 } },
        color: { value: '#ffffff' },
        shape: { type: 'circle' },
        opacity: { value: 0.5, random: true },
        size: { value: 3, random: true },
        line_linked: { enable: true, distance: 150, color: '#A78BFA', opacity: 0.4, width: 1 },
        move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
      },
      interactivity: {
        detect_on: 'canvas',
        events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
        modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
      },
      retina_detect: true
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const authNav = document.getElementById('authNav');
      const myDoubtsSection = document.getElementById('myDoubtsSection');
      const myDoubtsList = document.getElementById('myDoubtsList');
      const noDoubts = document.getElementById('noDoubts');
      const currentUser = auth.getCurrentUser();

      if (currentUser) {
        authNav.innerHTML = `
          <span class="text-sm text-gray-600">Hello, ${currentUser.name}</span>
          <a href="post-doubt.html" class="text-sm text-purple-600 hover:text-purple-800 ml-2">Post Doubt</a>
          <a href="my-doubts.html" class="text-sm text-purple-600 hover:text-purple-800 ml-2">My Doubts</a>
          <button onclick="auth.logout()" class="text-sm text-purple-600 hover:text-purple-800 ml-2">Logout</button>
        `;
        myDoubtsSection.style.display = 'block';

        try {
          const doubts = await api.getMyDoubts(currentUser.user_id);
          if (doubts.length === 0) {
            noDoubts.classList.remove('hidden');
          } else {
            noDoubts.classList.add('hidden');
            doubts.forEach(doubt => {
              const card = document.createElement('div');
              card.className = 'bg-white p-4 rounded-lg shadow-md doubt-card';
              card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                  <span class="inline-block px-2 py-1 text-xs font-semibold bg-purple-100 text-purple-800 rounded-full">
                    ${doubt.branch || 'General'}
                  </span>
                  <span class="text-xs text-gray-500">${utils.formatDate(doubt.created_at)}</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${doubt.subject}</h3>
                <p class="text-sm text-gray-600 mb-4">${utils.truncateText(doubt.description)}</p>
                <button onclick="viewResponses(${doubt.id})" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                  <i class="fas fa-comments mr-2"></i> View Responses (${doubt.response_count || 0})
                </button>
              `;
              myDoubtsList.appendChild(card);
            });
          }
        } catch (error) {
          utils.showToast('Failed to load my doubts', 'error');
          console.error('Error loading my doubts:', error);
        }
      } else {
        authNav.innerHTML = `
          <a href="login.html" class="text-sm text-purple-600 hover:text-purple-800">Login</a>
          <a href="register.html" class="text-sm text-purple-600 hover:text-purple-800">Register</a>
        `;
      }
    });

    window.viewResponses = (doubtId) => {
      window.location.href = `view-responses.html?id=${doubtId}`;
    };
  </script>

  <script type="module">
    import { auth } from './js/auth.js';
    import { api } from './js/api.js';

    window.auth = auth;
    window.api = api;

    document.addEventListener('DOMContentLoaded', async () => {
      const authNav = document.getElementById('authNav');
      const notificationBell = document.getElementById('notificationBell');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const notificationList = document.getElementById('notificationList');
      const unreadCount = document.getElementById('unreadCount');
      const markAllRead = document.getElementById('markAllRead');
      const currentUser = auth.getCurrentUser();

      if (currentUser) {
        // Poll for notifications every 30 seconds
        setInterval(async () => {
          try {
            const notifications = await api.getNotifications(currentUser.user_id);
            const unread = notifications.filter(n => !n.is_read);
            unreadCount.textContent = unread.length.toString();
            unreadCount.classList.toggle('hidden', unread.length === 0);

            notificationList.innerHTML = '';
            notifications.forEach(notif => {
              const div = document.createElement('div');
              div.className = 'text-sm text-gray-700 hover:bg-gray-100 p-2 rounded cursor-pointer';
              div.innerHTML = `${notif.message} <span class="${notif.is_read ? 'text-gray-400' : 'text-purple-600'}">[${new Date(notif.created_at).toLocaleString()}]</span>`;
              div.onclick = () => {
                if (!notif.is_read) {
                  api.markNotificationRead(notif.id);
                  notif.is_read = true;
                  div.classList.remove('text-purple-600');
                  div.classList.add('text-gray-400');
                  unreadCount.textContent = (unread.length - 1).toString();
                }
                window.location.href = `view-responses.html?id=${notif.doubt_id}`;
              };
              notificationList.appendChild(div);
            });
          } catch (error) {
            console.error('Notification polling error:', error);
          }
        }, 30000); // Poll every 30 seconds

        // Initial load (trigger immediately)
        (async () => {
          try {
            const notifications = await api.getNotifications(currentUser.user_id);
            const unread = notifications.filter(n => !n.is_read);
            unreadCount.textContent = unread.length.toString();
            unreadCount.classList.toggle('hidden', unread.length === 0);

            notificationList.innerHTML = '';
            notifications.forEach(notif => {
              const div = document.createElement('div');
              div.className = 'text-sm text-gray-700 hover:bg-gray-100 p-2 rounded cursor-pointer';
              div.innerHTML = `${notif.message} <span class="${notif.is_read ? 'text-gray-400' : 'text-purple-600'}">[${new Date(notif.created_at).toLocaleString()}]</span>`;
              div.onclick = () => {
                if (!notif.is_read) {
                  api.markNotificationRead(notif.id);
                  notif.is_read = true;
                  div.classList.remove('text-purple-600');
                  div.classList.add('text-gray-400');
                  unreadCount.textContent = (unread.length - 1).toString();
                }
                window.location.href = `view-responses.html?id=${notif.doubt_id}`;
              };
              notificationList.appendChild(div);
            });
          } catch (error) {
            console.error('Initial notification load error:', error);
          }
        })();

        // Toggle dropdown on bell click
        notificationBell.addEventListener('click', () => {
          notificationDropdown.classList.toggle('hidden');
        });

        // Mark all as read
        markAllRead.addEventListener('click', async () => {
          try {
            await api.markAllNotificationsRead(currentUser.user_id);
            notificationList.querySelectorAll('div').forEach(div => {
              div.classList.remove('text-purple-600');
              div.classList.add('text-gray-400');
            });
            unreadCount.classList.add('hidden');
          } catch (error) {
            console.error('Mark all read error:', error);
          }
        });
      } else {
        notificationBell.style.display = 'none';
      }
    });
  </script>
</body>
</html>